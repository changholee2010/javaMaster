<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="co.yedam.mybatis3.mapper.TxnMapper">

	<select id="searchList"
		resultType="co.yedam.mybatis3.vo.ProductVO">
		select prod_code
		      ,prod_name
		      ,selling_price
		from tbl_product
		where prod_code like '%'||#{prodCode}||'%'
		order by prod_code
	</select>

	<insert id="insertTransactions" parameterType="hashmap">
		insert into tbl_transactions (txn_id, prod_code, txn_qty, txn_date, creation_date)
		values(transactions_seq.nextval, #{code}, #{qty}
		<choose>
			<when test="txnDate != null">
                , #{txnDate}
			</when>
			<otherwise>
				, sysdate
			</otherwise>
		</choose>
		, sysdate)
	</insert>

	<select id="onhandList" resultType="co.yedam.mybatis3.vo.ProductVO" parameterType="co.yedam.mybatis3.common.SearchDTO">
		with onhand_t as 
	    ( select prod_code, sum(txn_qty) qty
	      from tbl_transactions
	      group by prod_code
	    )
	    select p.prod_code
	          ,p.prod_name
	          ,p.prod_desc
	          ,nvl(o.qty, 0) qty
	    from tbl_product p
	    <choose>
	      <when test="allProduct != null">
	        left outer join onhand_t o
	      </when>
	      <otherwise>
	        join onhand_t o
	      </otherwise>
	    </choose>
	    on p.prod_code = o.prod_code
	    order by p.prod_code
	</select>

</mapper>